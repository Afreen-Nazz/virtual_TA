# -*- coding: utf-8 -*-
"""Untitled1(1).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1azhzqwLizKPJo5vIrggjYOI3VgPH50ky
"""

# WORKING CHATBOT + API DEBUGGER
import gradio as gr
import traceback
from datetime import datetime

# Your API key
API_KEY = 'AIzaSyBQXPfWI6etj89lYogiBgL2mokBudO2zV0'

# Global status
api_status = "âŒ Not tested yet"
model = None
last_error = ""

def test_api_detailed():
    """Detailed API test with full error reporting"""
    global api_status, model, last_error

    try:
        print("ğŸ” Testing API step by step...")

        # Step 1: Install
        import subprocess
        result = subprocess.run(['pip', 'install', '-q', 'google-generativeai'],
                              capture_output=True, text=True, timeout=30)
        print(f"ğŸ“¦ Install result: {result.returncode}")

        # Step 2: Import
        import google.generativeai as genai
        print("âœ… Import successful")

        # Step 3: Configure
        genai.configure(api_key=API_KEY)
        print("âœ… API key configured")

        # Step 4: Try different models (gemini-pro might be deprecated)
        model_names = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro']

        for model_name in model_names:
            try:
                print(f"ğŸ§ª Trying model: {model_name}")
                model = genai.GenerativeModel(model_name)
                print(f"âœ… Model created: {model_name}")
                break
            except Exception as e:
                print(f"âŒ {model_name} failed: {e}")
                continue
        else:
            raise Exception("All models failed to load")

        # Step 5: Test generation with timeout
        print("ğŸ§ª Testing actual generation...")
        response = model.generate_content(
            "Say exactly: Hello I am working",
            generation_config=genai.types.GenerationConfig(
                max_output_tokens=20,
                temperature=0
            ),
            request_options={"timeout": 10}  # 10 second timeout
        )

        print(f"ğŸ“ Response object: {type(response)}")
        print(f"ğŸ“ Response text: {response.text}")
        print(f"ğŸ¯ Using model: {model.model_name if hasattr(model, 'model_name') else 'unknown'}")

        if response and response.text:
            api_status = "âœ… API WORKING!"
            return True, f"âœ… SUCCESS! Gemini said: '{response.text}'"
        else:
            api_status = "âŒ Empty response"
            return False, "âŒ API responded but returned empty text"

    except Exception as e:
        error_details = traceback.format_exc()
        last_error = str(e)
        api_status = f"âŒ Error: {str(e)[:50]}..."

        print(f"âŒ Full error: {error_details}")

        # Common error messages
        if "API_KEY" in str(e):
            return False, "âŒ API KEY ERROR: Your key might be invalid or expired"
        elif "quota" in str(e).lower():
            return False, "âŒ QUOTA ERROR: You might have exceeded API limits"
        elif "timeout" in str(e).lower():
            return False, "âŒ TIMEOUT ERROR: API is responding too slowly"
        elif "permission" in str(e).lower():
            return False, "âŒ PERMISSION ERROR: API key doesn't have access"
        else:
            return False, f"âŒ UNKNOWN ERROR: {str(e)}"

def smart_response(message):
    """Always working smart responses"""
    msg = message.lower().strip()

    responses = {
        "hello": "ğŸ‘‹ **Hello there!** I'm VirtuTA, your AI teaching assistant!\n\nğŸ“ I can help you with:\nâ€¢ **Programming** (Python, Java, algorithms)\nâ€¢ **Mathematics** (calculus, algebra, statistics)\nâ€¢ **Sciences** (physics, chemistry, biology)\nâ€¢ **Study tips** and learning strategies\n\nWhat would you like to learn today?",

        "help": "ğŸ†˜ **I'm here to help!** Here's what I can do:\n\nğŸ“š **Explain Concepts**\nâ€¢ Break down complex topics\nâ€¢ Provide step-by-step explanations\nâ€¢ Give real-world examples\n\nğŸ§® **Solve Problems**\nâ€¢ Math equations and proofs\nâ€¢ Programming challenges\nâ€¢ Science problems\n\nğŸ’¡ **Study Support**\nâ€¢ Learning strategies\nâ€¢ Exam preparation tips\nâ€¢ Time management advice\n\nJust ask me anything!",

        "programming": "ğŸ’» **Programming Help Available!**\n\nğŸ **Languages I can help with:**\nâ€¢ Python, Java, C++, JavaScript\nâ€¢ HTML/CSS, SQL, R\n\nğŸ§  **Topics I cover:**\nâ€¢ Data structures & algorithms\nâ€¢ Object-oriented programming\nâ€¢ Debugging techniques\nâ€¢ Best practices\n\nğŸ“ **What I can do:**\nâ€¢ Explain code concepts\nâ€¢ Help debug errors\nâ€¢ Suggest improvements\nâ€¢ Provide examples\n\nWhat programming topic interests you?",

        "math": "ğŸ”¢ **Mathematics Assistance Ready!**\n\nğŸ“Š **Areas I specialize in:**\nâ€¢ Calculus (derivatives, integrals)\nâ€¢ Algebra (equations, functions)\nâ€¢ Statistics & probability\nâ€¢ Linear algebra\nâ€¢ Discrete mathematics\n\nâš¡ **How I help:**\nâ€¢ Step-by-step solutions\nâ€¢ Concept explanations\nâ€¢ Practice problems\nâ€¢ Exam preparation\n\nWhat math topic can I help clarify?",

        "science": "ğŸ”¬ **Science Help Available!**\n\nğŸ§ª **Subjects I cover:**\nâ€¢ Physics (mechanics, electromagnetism)\nâ€¢ Chemistry (organic, inorganic, physical)\nâ€¢ Biology (cell biology, genetics, ecology)\nâ€¢ Earth sciences\n\nğŸ¯ **My approach:**\nâ€¢ Clear explanations\nâ€¢ Visual analogies\nâ€¢ Practice problems\nâ€¢ Real-world applications\n\nWhich science topic interests you?",

        "study": "ğŸ“– **Study Strategies & Tips!**\n\nğŸ¯ **Effective Study Methods:**\nâ€¢ Spaced repetition for memorization\nâ€¢ Active recall techniques\nâ€¢ Pomodoro technique for focus\nâ€¢ Mind mapping for connections\n\nâ° **Time Management:**\nâ€¢ Creating study schedules\nâ€¢ Prioritizing tasks\nâ€¢ Breaking down large topics\nâ€¢ Managing procrastination\n\nâœ… **Exam Preparation:**\nâ€¢ Practice test strategies\nâ€¢ Review techniques\nâ€¢ Stress management\n\nWhat specific study challenge can I help with?"
    }

    # Check for specific topics
    if any(word in msg for word in ["hello", "hi", "hey", "start"]):
        return responses["hello"]
    elif "help" in msg or "assist" in msg:
        return responses["help"]
    elif any(word in msg for word in ["program", "code", "algorithm", "python", "java"]):
        return responses["programming"]
    elif any(word in msg for word in ["math", "calculus", "algebra", "equation"]):
        return responses["math"]
    elif any(word in msg for word in ["science", "physics", "chemistry", "biology"]):
        return responses["science"]
    elif any(word in msg for word in ["study", "exam", "learn", "prepare"]):
        return responses["study"]
    else:
        return f"ğŸ¤” **Great question about:** *{message}*\n\nğŸ“š I'd love to help explain that topic! To give you the best answer, could you tell me:\n\nâ€¢ What specific aspect interests you most?\nâ€¢ What's your current understanding level?\nâ€¢ Is this for a particular course or project?\n\nThe more details you provide, the better I can tailor my explanation!"

def chat_function(message, history):
    """Main chat function that always works"""
    global api_status, model

    if not message.strip():
        return history, history

    # Always try smart response first (instant)
    smart_reply = smart_response(message)

    # Try Gemini if available
    gemini_reply = None
    if model:
        try:
            response = model.generate_content(
                f"You are VirtuTA, a helpful teaching assistant. Answer this student question clearly and helpfully: {message}",
                generation_config={'max_output_tokens': 300, 'temperature': 0.7}
            )
            if response and response.text:
                gemini_reply = response.text
        except Exception as e:
            print(f"Gemini failed: {e}")

    # Use best available response
    if gemini_reply:
        bot_response = f"ğŸ¤– **VirtuTA (AI Enhanced):**\n\n{gemini_reply}"
    else:
        bot_response = f"ğŸ¤– **VirtuTA (Smart Mode):**\n\n{smart_reply}"

    # Add to history
    history.append([message, bot_response])
    return history, history

def run_api_test():
    """Run API test and return results"""
    success, message = test_api_detailed()
    return message, api_status

def get_debug_info():
    """Get debug information"""
    return f"""ğŸ” **Debug Information:**

ğŸ”‘ **API Key:** {API_KEY[:20]}...{API_KEY[-5:]}
ğŸ“¡ **Current Status:** {api_status}
âŒ **Last Error:** {last_error or 'None'}
ğŸ¤– **Model Status:** {'Loaded' if model else 'Not loaded'}
â° **Time:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

ğŸ’¡ **Troubleshooting Tips:**
â€¢ Try clicking "Test API" button
â€¢ Check if your API key is valid at: https://makersuite.google.com/app/apikey
â€¢ Make sure you have API quota remaining
â€¢ Check your internet connection
"""

# Create working interface
with gr.Blocks(title="VirtuTA - Always Working!", css=".chatbot {height: 500px !important}") as demo:

    gr.HTML("""
    <div style="text-align: center; padding: 20px; background: linear-gradient(45deg, #FF6B35, #F7931E); color: white; border-radius: 15px; margin-bottom: 20px;">
        <h1>ğŸ“ VirtuTA - AI Teaching Assistant</h1>
        <h3>âœ… ALWAYS WORKING - Smart Responses Guaranteed!</h3>
        <p>Ask me anything - I'll help with or without the API!</p>
    </div>
    """)

    with gr.Row():
        with gr.Column(scale=3):
            chatbot = gr.Chatbot(
                label="ğŸ’¬ Chat with VirtuTA",
                height=500,
                show_label=True
            )

            msg = gr.Textbox(
                label="ğŸ’­ Your Question",
                placeholder="Ask me anything! Try: 'Hello', 'Explain recursion', 'Help with calculus'",
                lines=3,
                max_lines=5
            )

            with gr.Row():
                send_btn = gr.Button("Send ğŸš€", variant="primary", scale=2)
                clear_btn = gr.Button("Clear ğŸ—‘ï¸", scale=1)

        with gr.Column(scale=1):
            gr.Markdown("### ğŸ”§ API Diagnostics")

            test_btn = gr.Button("ğŸ§ª Test Gemini API", variant="secondary")

            api_result = gr.Textbox(
                label="ğŸ” API Test Result",
                value="Click 'Test Gemini API' to check your key",
                lines=4,
                interactive=False
            )

            status_box = gr.Textbox(
                label="ğŸ“Š Current Status",
                value=api_status,
                lines=2,
                interactive=False
            )

            debug_btn = gr.Button("ğŸ› Debug Info")

            debug_info = gr.Textbox(
                label="ğŸ” Debug Details",
                lines=8,
                interactive=False
            )

    # Example questions
    gr.Examples(
        examples=[
            ["Hello VirtuTA! How can you help me?"],
            ["Explain how binary search works"],
            ["Help me understand calculus derivatives"],
            ["What's the best way to study for programming exams?"],
            ["Can you help me debug this Python code?"]
        ],
        inputs=[msg],
        label="ğŸ’¡ Try These Examples (Click to Use)"
    )

    # Event handlers
    msg.submit(chat_function, [msg, chatbot], [chatbot, chatbot]).then(
        lambda: "", outputs=[msg]
    )

    send_btn.click(chat_function, [msg, chatbot], [chatbot, chatbot]).then(
        lambda: "", outputs=[msg]
    )

    clear_btn.click(lambda: ([], []), outputs=[chatbot, chatbot])

    test_btn.click(run_api_test, outputs=[api_result, status_box])

    debug_btn.click(get_debug_info, outputs=[debug_info])

    gr.HTML("""
    <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 10px;">
        <h4 style="color: #2d5a3d;">âœ… This Chatbot ALWAYS Works!</h4>
        <p style="color: #2d5a3d; margin: 0;">Even if Gemini API fails, you'll get intelligent responses. Click "Test Gemini API" to diagnose any issues!</p>
    </div>
    """)

# Test API on startup
print("ğŸ§ª Testing your Gemini API...")
api_test_result = test_api_detailed()
print(f"ğŸ” API Test Result: {api_test_result}")

if __name__ == "__main__":
    print("ğŸš€ Launching ALWAYS-WORKING VirtuTA...")
    print("ğŸ’¯ This version will respond to every message!")

    demo.launch(
        share=True,
        debug=True,
        show_error=True
    )

    print("âœ… VirtuTA is live and ready!")
    print("ğŸ’¬ Try asking 'Hello' - you'll get a response no matter what!")

